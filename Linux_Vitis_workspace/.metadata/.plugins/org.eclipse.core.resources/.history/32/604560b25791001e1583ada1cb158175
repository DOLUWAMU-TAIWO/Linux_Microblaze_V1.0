#include "xparameters.h"
#include "xgpio.h"
#include "xil_printf.h"

#define SEVEN_SEG_DEVICE_ID XPAR_AXI_GPIO_SEVEN_DEVICE_ID
#define BUTTONS_DEVICE_ID XPAR_AXI_GPIO_BUTTON_DEVICE_ID

XGpio SevenSegInst, ButtonInst;

int InitializeGpio(XGpio *InstancePtr, u16 DeviceId, u32 isOutput);
void DisplayNumber(XGpio *InstancePtr, int number);

int main() {
    int Status;
    int button_pressed = 0;
    int number_to_display = 0;

    // Initialize Seven Segment GPIO
    Status = InitializeGpio(&SevenSegInst, SEVEN_SEG_DEVICE_ID, 1); // Set as output
    if (Status != XST_SUCCESS) {
        xil_printf("Seven Segment GPIO Initialization Failed\r\n");
        return XST_FAILURE;
    }

    // Initialize Button GPIO
    Status = InitializeGpio(&ButtonInst, BUTTONS_DEVICE_ID, 0); // Set as input
    if (Status != XST_SUCCESS) {
        xil_printf("Button GPIO Initialization Failed\r\n");
        return XST_FAILURE;
    }

    // Clear the seven segment display initially
    DisplayNumber(&SevenSegInst, -1);

    while (1) {
        // Read button state
        button_pressed = XGpio_DiscreteRead(&ButtonInst, 1);
        if (button_pressed) {
            DisplayNumber(&SevenSegInst, number_to_display);
            number_to_display = (number_to_display + 1) % 10;
            while (XGpio_DiscreteRead(&ButtonInst, 1)); // Wait for button release
        }
    }

    return XST_SUCCESS;
}

int InitializeGpio(XGpio *InstancePtr, u16 DeviceId, u32 isOutput) {
    int Status = XGpio_Initialize(InstancePtr, DeviceId);
    if (Status != XST_SUCCESS) {
        return XST_FAILURE;
    }
    XGpio_SetDataDirection(InstancePtr, 1, isOutput ? 0x0 : 0xFFFFFFFF); // Set as output or input
    return XST_SUCCESS;
}

void DisplayNumber(XGpio *InstancePtr, int number) {
    u32 seg_value;

    switch (number) {
        case 0: seg_value = 0b00111111; break; // 0
        case 1: seg_value = 0b00000110; break; // 1
        // ... Define the rest of the numbers
        case 9: seg_value = 0b00100111; break; // 9
        default: seg_value = 0b00000000; break; // Clear display
    }

    XGpio_DiscreteWrite(InstancePtr, 1, seg_value);
}
